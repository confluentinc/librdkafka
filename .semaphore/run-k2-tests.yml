version: v1.0
name: run-k2-tests
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-3

execution_time_limit:
  hours: 3

blocks:
  - name: "K2 Testing Setup"
    task:
      prologue:
        commands:
          # Setup paths (same as cc-system-tests-kafka)
          - export SEMAPHORE_GIT_DIR=/home/semaphore/${SEMAPHORE_PROJECT_NAME}
          - export "PATH=${SEMAPHORE_GIT_DIR}/cc-dotfiles/bin/k8saas-ga:${PATH}"
          - mkdir -vp "${SEMAPHORE_GIT_DIR}"
          - checkout
          # Vault setup
          - . vault-setup
          - . vault-sem-get-secret cc-system-tests
          - . vault-sem-get-secret GCP_CONNECT_CREDENTIALS_DEVEL
          - export AWS_AUTH_METHOD=aws-creds
      jobs:
        - name: "Get kubectl access and verify"
          commands:
            # Install oidc-kubelogin
            - curl -sL https://github.com/int128/kubelogin/releases/download/v1.28.0/kubelogin_linux_amd64.zip -o /tmp/kubelogin.zip && unzip -o /tmp/kubelogin.zip -d /tmp && sudo mv /tmp/kubelogin /usr/local/bin/oidc-kubelogin && chmod +x /usr/local/bin/oidc-kubelogin
            # Clone tools
            - git clone --depth 1 git@github.com:confluentinc/cc-dotfiles.git ${SEMAPHORE_GIT_DIR}/cc-dotfiles
            - git clone --depth 1 git@github.com:confluentinc/cc-mk-include.git ${SEMAPHORE_GIT_DIR}/mk-include
            - export "PATH=${SEMAPHORE_GIT_DIR}/cc-dotfiles/bin/k8saas-ga:${PATH}"
            # Setup kubeconfig
            - cd ${SEMAPHORE_GIT_DIR} && . mk-include/bin/cc-system-tests/setup_kubeconfig.sh devel
            - export KUBECONFIG=$HOME/.kube/ccloud-config/devel/kubeconfig
            # Verify kubectl access
            - kubectl config get-contexts
            - kubectl --context ${K8S_CONTEXT:-k8s-devcnn3k3} get namespaces
            - kubectl --context ${K8S_CONTEXT:-k8s-devcnn3k3} get pod ${TOOLBOX_ID:-anl-le-new} || echo "Toolbox pod not found (provide TOOLBOX_ID)"
            # Sleep for 2 hours for manual access
            - |
              echo "=============================================="
              echo "kubectl access is working!"
              echo "Sleeping for 2 hours - you can SSH in now"
              echo "To exec into toolbox:"
              echo "  kubectl --context ${K8S_CONTEXT:-k8s-devcnn3k3} exec -it ${TOOLBOX_ID:-anl-le-new} -- bash"
              echo "=============================================="
              sleep 7200
