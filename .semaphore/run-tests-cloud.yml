version: v1.0
name: run-tests-cloud

agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-00

execution_time_limit:
  hours: 3

global_job_config:
  prologue:
    commands:
      - sem-version go 1.23.6
      - sem-version kubectl 1.29.0
      - export "GOPATH=$(go env GOPATH)"
      - export "SEMAPHORE_GIT_DIR=${GOPATH}/src/github.com/confluentinc/${SEMAPHORE_PROJECT_NAME}"
      - export "PATH=${GOPATH}/bin:${PATH}"
      - export "PATH=${SEMAPHORE_GIT_DIR}/cc-dotfiles/bin/k8saas-ga:${PATH}"
      - mkdir -vp "${SEMAPHORE_GIT_DIR}" "${GOPATH}/bin"
      - checkout
      - . vault-setup
      - . vault-sem-get-secret cc-system-tests
      - . vault-sem-get-secret GCP_CONNECT_CREDENTIALS_DEVEL
      - . vault-get-secret --vault-role=default njc/service-account-credentials
      - export AWS_AUTH_METHOD=aws-creds

blocks:
  - name: "Integration Testing against Cloud Environment"
    task:
      epilogue:
        always:
          commands:
            # Step 2: Publish test results to Semaphore
            - |
              if [[ -f /tmp/junit_report.xml ]]; then
                echo "Publishing test results..."
                test-results publish /tmp/junit_report.xml
              else
                echo "No test report found to publish"
              fi
            - |
              if [[ "$KAFKA_TYPE" == "k2" ]]; then
                echo "Cleaning up pod njc-test-pod-${SEMAPHORE_JOB_ID}..."
                kubectl --context ${K8S_CONTEXT} delete pod njc-test-pod-${SEMAPHORE_JOB_ID} \
                  --ignore-not-found=true || echo "Failed to delete pod"
              fi
            - |
              if [[ -f /tmp/api-key-id.txt ]]; then
                API_KEY_ID=$(cat /tmp/api-key-id.txt)
                CLI_BIN=$(find /tmp/cli/dist -type f -name 'confluent' -executable 2>/dev/null | head -1)
                if [[ -n "$CLI_BIN" ]]; then
                  $CLI_BIN api-key delete ${API_KEY_ID} --force || echo "Failed to delete API key"
                else
                  echo "CLI not found, skipping API key cleanup"
                fi
                rm -f /tmp/api-key-id.txt
              fi

      jobs:
        - name: "run-tests-cloud"
          commands:
            - |
              export LIBRDKAFKA_VERSION="${LIBRDKAFKA_VERSION:-master}"
              
              if [[ -z "$LKC" ]]; then
                echo "Error: LKC is required"
                exit 1
              fi
              if [[ -z "$ENV_ID" ]]; then
                echo "Error: ENV_ID is required"
                exit 1
              fi
              if [[ -z "$ORG_ID" ]]; then
                echo "Error: ORG_ID is required"
                exit 1
              fi
              if [[ -z "$KAFKA_TYPE" ]]; then
                echo "Error: KAFKA_TYPE is required (k1 or k2)"
                exit 1
              fi
              if [[ "$KAFKA_TYPE" != "k1" && "$KAFKA_TYPE" != "k2" ]]; then
                echo "Error: KAFKA_TYPE must be 'k1' or 'k2'"
                exit 1
              fi
              if [[ "$KAFKA_TYPE" == "k2" && -z "$K8S_CONTEXT" ]]; then
                echo "Error: K8S_CONTEXT is required for K2 testing"
                exit 1
              fi
              
              echo "Running ${KAFKA_TYPE^^} tests..."

            - |
              if [[ "$KAFKA_TYPE" == "k2" ]]; then
                echo "Installing oidc-kubelogin..."
                curl -sL -o /tmp/kubelogin.zip \
                  https://github.com/int128/kubelogin/releases/download/v1.28.0/kubelogin_linux_amd64.zip
                unzip -o /tmp/kubelogin.zip -d /tmp
                sudo mv /tmp/kubelogin /usr/local/bin/oidc-kubelogin
                chmod +x /usr/local/bin/oidc-kubelogin
                
                git clone --depth 1 \
                  git@github.com:confluentinc/cc-dotfiles.git ${SEMAPHORE_GIT_DIR}/cc-dotfiles
                git clone --depth 1 \
                  git@github.com:confluentinc/cc-mk-include.git ${SEMAPHORE_GIT_DIR}/mk-include
                
                echo "Assuming AWS role for devel environment..."
                . assume-iam-role arn:aws:iam::037803949979:role/semaphore-access
                aws sts get-caller-identity
                
                echo "Setting up kubeconfig..."
                ${SEMAPHORE_GIT_DIR}/mk-include/bin/cc-system-tests/setup_kubeconfig.sh devel
                export KUBECONFIG=$HOME/.kube/ccloud-config/devel/kubeconfig
              else
                echo "K1 mode - skipping K8s setup"
              fi

            - echo "Installing Confluent CLI..."
            - git clone --depth 1 git@github.com:confluentinc/cli.git /tmp/cli
            - |
              cd /tmp/cli
              go install github.com/goreleaser/goreleaser@v1.15.2
              make build
            - |
              CLI_DIR=$(find /tmp/cli/dist -type f -name 'confluent' -executable | head -1 | xargs dirname)
              export CLI_DIR
              export PATH="${CLI_DIR}:${PATH}"
            - export CONFLUENT_CLOUD_EMAIL="${NJC_CCLOUD_USER_EMAIL}"
            - export CONFLUENT_CLOUD_PASSWORD="${NJC_CCLOUD_USER_PASSWORD}"
            - confluent login --url https://devel.cpdev.cloud --organization ${ORG_ID}

            - echo "Getting cluster details..."
            - confluent environment use ${ENV_ID}
            - confluent kafka cluster describe ${LKC} --output json > /tmp/cluster-info.json
            - |
              BOOTSTRAP_SERVER=$(jq -r '.endpoint' /tmp/cluster-info.json | sed 's|SASL_SSL://||')
              echo "${BOOTSTRAP_SERVER}" > /tmp/bootstrap-server.txt

            - echo "Creating API key for cluster ${LKC}..."
            - |
              if ! confluent api-key create --resource ${LKC} --output json > /tmp/api-key.json 2>&1; then
                echo "Failed to create API key"
                cat /tmp/api-key.json
                exit 1
              fi
              jq -r '.api_key // .key' /tmp/api-key.json > /tmp/api-key.txt
              jq -r '.api_secret // .secret' /tmp/api-key.json > /tmp/api-secret.txt
              cat /tmp/api-key.txt > /tmp/api-key-id.txt

            - export BOOTSTRAP_SERVER=$(cat /tmp/bootstrap-server.txt)
            - export API_KEY=$(cat /tmp/api-key.txt)
            - export API_SECRET=$(cat /tmp/api-secret.txt)
            - rm -f /tmp/api-key.json /tmp/cluster-info.json
            - 'echo "Using librdkafka version: ${LIBRDKAFKA_VERSION}"'

            - |
              if [[ "$KAFKA_TYPE" == "k1" ]]; then
                echo "Cleaning up any existing system librdkafka..."
                sudo rm -f /usr/local/lib/librdkafka*
                sudo ldconfig
                
                echo "Cloning and building test harness (k2_testing_final)..."
                cd /tmp && git clone https://github.com/confluentinc/librdkafka.git
                cd /tmp/librdkafka && git checkout k2_testing_final
                LDFLAGS="-Wl,-z,lazy" ./configure --enable-ssl
                make
                cd tests && make test-runner
                
                echo "Cloning and building librdkafka ${LIBRDKAFKA_VERSION}..."
                mkdir -p /tmp/librd_ver
                cd /tmp/librd_ver && git clone https://github.com/confluentinc/librdkafka.git
                cd /tmp/librd_ver/librdkafka && git checkout ${LIBRDKAFKA_VERSION}
                ./configure --enable-ssl
                make
                sudo make install
                
                echo "Creating test.conf..."
                printf '%s\n' \
                  "security.protocol=SASL_SSL" \
                  "sasl.mechanism=PLAIN" \
                  "sasl.username=${API_KEY}" \
                  "sasl.password=${API_SECRET}" \
                  "ssl.endpoint.identification.algorithm=none" \
                  "test.timeout.multiplier=5" \
                  "test.topic.prefix=njc-test-" \
                  "test.topic.random=true" \
                  "metadata.broker.list=${BOOTSTRAP_SERVER}" \
                  "test.sleep.multiplier=2.0" \
                  > /tmp/librdkafka/tests/test.conf
              fi

            - |
              if [[ "$KAFKA_TYPE" == "k2" ]]; then
                export TOOLBOX_POD="njc-test-pod-${SEMAPHORE_JOB_ID}"
                
                echo "Creating pod ${TOOLBOX_POD}..."
                kubectl --context ${K8S_CONTEXT} run ${TOOLBOX_POD} \
                  --image=debian:latest --command -- sleep infinity
                kubectl --context ${K8S_CONTEXT} wait \
                  --for=condition=Ready pod/${TOOLBOX_POD} --timeout=120s
                
                echo "Installing build dependencies..."
                kubectl --context ${K8S_CONTEXT} exec ${TOOLBOX_POD} -- bash -c '
                  apt-get update -qq && apt-get install -y \
                    apt-transport-https ca-certificates curl gnupg wget git \
                    build-essential libssl-dev \
                    vim screen htop atop jq strace openssl psmisc \
                    bind9-dnsutils tcpdump traceroute iputils-ping \
                    net-tools iproute2 telnet mtr-tiny conntrack \
                    httping man-db iptables'
                
                kubectl --context ${K8S_CONTEXT} exec ${TOOLBOX_POD} -- bash -c '
                  apt-get install -y \
                    llvm-17 llvm-17-tools llvm clang \
                    openjdk-21-jdk default-jdk \
                    iotop nethogs'
                
                echo "Cloning and building test harness (k2_testing_final)..."
                kubectl --context ${K8S_CONTEXT} exec ${TOOLBOX_POD} -- bash -c '
                  cd /tmp && git clone https://github.com/confluentinc/librdkafka.git
                  cd librdkafka && git checkout k2_testing_final'
                kubectl --context ${K8S_CONTEXT} exec ${TOOLBOX_POD} -- bash -c '
                  cd /tmp/librdkafka
                  ./configure --enable-ssl --disable-optimization
                  make
                  cd tests && make test-runner' \
                  || { echo "FAILED: k2_testing_final build"; exit 1; }
                
                echo "Cloning and building librdkafka ${LIBRDKAFKA_VERSION}..."
                kubectl --context ${K8S_CONTEXT} exec ${TOOLBOX_POD} -- bash -c "
                  mkdir -p /tmp/librd_ver
                  cd /tmp/librd_ver && git clone https://github.com/confluentinc/librdkafka.git
                  cd librdkafka && git checkout ${LIBRDKAFKA_VERSION}"
                kubectl --context ${K8S_CONTEXT} exec ${TOOLBOX_POD} -- bash -c '
                  cd /tmp/librd_ver/librdkafka
                  ./configure --enable-ssl --disable-optimization
                  make
                  make install' \
                  || { echo "FAILED: version build"; exit 1; }
                
                echo "Creating test.conf..."
                printf '%s\n' \
                  "security.protocol=SASL_SSL" \
                  "sasl.mechanism=PLAIN" \
                  "sasl.username=${API_KEY}" \
                  "sasl.password=${API_SECRET}" \
                  "ssl.endpoint.identification.algorithm=none" \
                  "test.timeout.multiplier=20" \
                  "test.topic.prefix=njc-test-" \
                  "test.topic.random=true" \
                  "metadata.broker.list=${BOOTSTRAP_SERVER}" \
                  "test.supported.acks=-1" \
                  "test.sleep.multiplier=3.0" \
                  "test.skip.idempotent=true" \
                  "test.skip.numbers=0011,0059,0081" \
                  > /tmp/test.conf
                kubectl --context ${K8S_CONTEXT} cp \
                  /tmp/test.conf ${TOOLBOX_POD}:/tmp/librdkafka/tests/test.conf
                rm -f /tmp/test.conf
              fi

            - rm -f /tmp/api-key.txt /tmp/api-secret.txt /tmp/bootstrap-server.txt

            - |
              # Only run tests 0001-0050
              TESTS_TO_RUN="0001,0002,0003,0004,0005,0006,0007,0008,0009,0010"
              TESTS_TO_RUN="${TESTS_TO_RUN},0011,0012,0013,0014,0015,0016,0017,0018,0019,0020"
              TESTS_TO_RUN="${TESTS_TO_RUN},0021,0022,0025,0026,0028,0029,0030,0031,0033,0034"
              TESTS_TO_RUN="${TESTS_TO_RUN},0035,0036,0037,0038,0039,0040,0041,0042,0043,0044"
              TESTS_TO_RUN="${TESTS_TO_RUN},0045,0046,0047,0048,0049,0050,0051,0052"
              
              if [[ "$KAFKA_TYPE" == "k1" ]]; then
                cd /tmp/librdkafka/tests
                echo "Running tests with librdkafka ${LIBRDKAFKA_VERSION}..."
                LD_PRELOAD="/tmp/librd_ver/librdkafka/src-cpp/librdkafka++.so"
                LD_PRELOAD="$LD_PRELOAD:/tmp/librd_ver/librdkafka/src/librdkafka.so"
                LD_LIBRARY_PATH="/tmp/librd_ver/librdkafka/src-cpp"
                LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/tmp/librd_ver/librdkafka/src"
                export LD_PRELOAD LD_LIBRARY_PATH
                # Capture output to extract error messages for failed tests
                TESTS="${TESTS_TO_RUN}" TEST_REPORT=/tmp/test_report.json ./run-test.sh -r 2>&1 | tee /tmp/test_output.log || true
              else
                export TOOLBOX_POD="njc-test-pod-${SEMAPHORE_JOB_ID}"
                echo "Running tests in pod ${TOOLBOX_POD} with librdkafka ${LIBRDKAFKA_VERSION}..."
                kubectl --context ${K8S_CONTEXT} exec ${TOOLBOX_POD} -- bash -c "
                  cd /tmp/librdkafka/tests
                  export LD_PRELOAD=\"/tmp/librd_ver/librdkafka/src-cpp/librdkafka++.so\"
                  export LD_PRELOAD=\"\$LD_PRELOAD:/tmp/librd_ver/librdkafka/src/librdkafka.so\"
                  export LD_LIBRARY_PATH=\"/tmp/librd_ver/librdkafka/src-cpp\"
                  export LD_LIBRARY_PATH=\"\$LD_LIBRARY_PATH:/tmp/librd_ver/librdkafka/src\"
                  TESTS=\"${TESTS_TO_RUN}\" TEST_REPORT=/tmp/test_report.json ./run-test.sh -r" 2>&1 | tee /tmp/test_output.log || true
                
                # Copy report from pod
                kubectl --context ${K8S_CONTEXT} cp \
                  ${TOOLBOX_POD}:/tmp/test_report.json /tmp/test_report.json 2>/dev/null || \
                kubectl --context ${K8S_CONTEXT} exec ${TOOLBOX_POD} -- bash -c \
                  'cat /tmp/librdkafka/tests/test_report_*.json 2>/dev/null' \
                  > /tmp/test_report.json || true
              fi

            # Convert JSON report to JUnit XML for Semaphore test tab
            - |
              REPORT_FILE="/tmp/test_report.json"
              LOG_FILE="/tmp/test_output.log"
              
              if [[ ! -f "$REPORT_FILE" ]]; then
                REPORT_FILE=$(ls /tmp/librdkafka/tests/test_report_*.json 2>/dev/null | head -1)
              fi
              
              # Extract error messages from test output log for failed tests
              # Format: | test_name | FAILED | time | error_message
              if [[ -f "$LOG_FILE" ]]; then
                echo "Extracting error messages from test log..."
                grep -E "^\|.*FAILED" "$LOG_FILE" | while read -r line; do
                  # Extract test name and error message
                  TEST_NAME=$(echo "$line" | awk -F'|' '{gsub(/^[ \t]+|[ \t]+$/, "", $2); print $2}')
                  ERROR_MSG=$(echo "$line" | awk -F'|' '{gsub(/^[ \t]+|[ \t]+$/, "", $5); print $5}')
                  if [[ -n "$TEST_NAME" && -n "$ERROR_MSG" ]]; then
                    echo "${TEST_NAME}::${ERROR_MSG}" >> /tmp/test_errors.txt
                  fi
                done
              fi
              
              if [[ -f "$REPORT_FILE" && -s "$REPORT_FILE" ]]; then
                echo "Converting $REPORT_FILE to JUnit XML..."
                TESTS_RUN=$(jq -r '.tests_run // 0' "$REPORT_FILE")
                TESTS_FAILED=$(jq -r '.tests_failed // 0' "$REPORT_FILE")
                DURATION=$(jq -r '.duration // 0' "$REPORT_FILE")
                
                # Write XML header
                echo '<?xml version="1.0" encoding="UTF-8"?>' > /tmp/junit_report.xml
                echo "<testsuites tests=\"${TESTS_RUN}\" failures=\"${TESTS_FAILED}\" errors=\"0\" time=\"${DURATION}\">" >> /tmp/junit_report.xml
                echo "  <testsuite name=\"librdkafka\" tests=\"${TESTS_RUN}\" failures=\"${TESTS_FAILED}\" errors=\"0\" time=\"${DURATION}\">" >> /tmp/junit_report.xml
                
                # Process each test
                jq -r '.tests | to_entries | sort_by(.key) | .[] | [.key, .value.name, .value.state, .value.duration, .value.extra, .value.known_issue] | @tsv' "$REPORT_FILE" | \
                while IFS=$'\t' read -r key name state duration extra known_issue; do
                  # Escape XML special characters
                  name_escaped=$(echo "$name" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
                  
                  echo -n "    <testcase classname=\"librdkafka.tests\" name=\"${name_escaped}\" time=\"${duration}\">" >> /tmp/junit_report.xml
                  
                  if [[ "$state" == "FAILED" ]]; then
                    # Try to get error from captured log
                    error_msg=""
                    if [[ -f /tmp/test_errors.txt ]]; then
                      error_msg=$(grep "^${name}::" /tmp/test_errors.txt 2>/dev/null | head -1 | sed "s/^${name}:://")
                    fi
                    if [[ -z "$error_msg" && -n "$extra" && "$extra" != "null" ]]; then
                      error_msg="$extra"
                    fi
                    if [[ -z "$error_msg" ]]; then
                      error_msg="Test failed - check logs for details"
                    fi
                    error_escaped=$(echo "$error_msg" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
                    echo "<failure message=\"Test failed\">${error_escaped}</failure>" >> /tmp/junit_report.xml
                  elif [[ "$state" == "SKIPPED" ]]; then
                    skip_reason="Test requirements not met or not selected"
                    if [[ -n "$extra" && "$extra" != "null" && "$extra" != "" ]]; then
                      skip_reason="$extra"
                    elif [[ "$known_issue" == "true" ]]; then
                      skip_reason="Known issue"
                    elif [[ "$name" == *"mock"* ]]; then
                      skip_reason="Requires mock cluster"
                    elif [[ "$name" == *"local"* ]]; then
                      skip_reason="Local test only"
                    fi
                    skip_escaped=$(echo "$skip_reason" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
                    echo "<skipped message=\"${skip_escaped}\"/>" >> /tmp/junit_report.xml
                  else
                    echo "<system-out>PASSED</system-out>" >> /tmp/junit_report.xml
                  fi
                  
                  echo "</testcase>" >> /tmp/junit_report.xml
                done
                
                # Write XML footer
                echo "  </testsuite>" >> /tmp/junit_report.xml
                echo "</testsuites>" >> /tmp/junit_report.xml
                
                rm -f /tmp/test_errors.txt
                echo "Generated /tmp/junit_report.xml"
              else
                echo "No test report found, creating empty JUnit report..."
                echo '<?xml version="1.0" encoding="UTF-8"?>' > /tmp/junit_report.xml
                echo '<testsuites tests="0" failures="0" errors="0" time="0">' >> /tmp/junit_report.xml
                echo '  <testsuite name="librdkafka" tests="0" failures="0" errors="0"/>' >> /tmp/junit_report.xml
                echo '</testsuites>' >> /tmp/junit_report.xml
              fi

# Step 3: After-pipeline job to merge all test results
after_pipeline:
  task:
    jobs:
      - name: "Generate Test Report"
        commands:
          - test-results gen-pipeline-report
