# This file is managed by ServiceBot plugin - Semaphore. The content in this file is created using a common
# template and configurations in service.yml.
# Any modifications made to version, name, agent, and global_job_config will be overwritten by the generated
# content in nightly runs. Code changes made to the remaining sections will not be affected.
# For more information, please refer to the page:
# https://confluentinc.atlassian.net/wiki/spaces/Foundations/pages/2871296194/Add+SemaphoreCI
version: v1.0
name: build-test-release
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1

auto_cancel:
  running:
    when: "branch != 'master'"

execution_time_limit:
  hours: 1

queue:
  - when: "branch != 'master'"
    processing: parallel

global_job_config:
  prologue:
    commands:
      - checkout
      - git submodule update --init --recursive
      - cd deps/librdkafka
      - git fetch origin
      - git checkout master
      - cd ../../
      - export MKL_DEBUG=1



blocks:
  - name: "Linux amd64 (musl): Build and test"
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-2
      jobs:
        - name: "Build from source and test for musl"
          commands:
            - docker run -v "$(pwd):/v" node:18-alpine /v/.semaphore/build-docker.sh

  - name: "Linux arm64 (musl): Build and test"
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-arm64-1
      jobs:
        - name: "Build from source and test for musl"
          commands:
              - docker run -v "$(pwd):/v" node:18-alpine /v/.semaphore/build-docker.sh

  - name: "Linux arm64: Build and test"
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-arm64-1
      jobs:
        - name: "Build from source and test"
          commands:
            - npm install # this will actually not build anything if we have a release, but rather, fetch things using node-pre-gyp - so change this later.
            - make test

  - name: 'macOS arm64/m1: Build and test'
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-macos-13-5-arm64
      jobs:
        - name: 'Build from source and test'
          commands:
            - npm install # this will actually not build anything if we have a release, but rather, fetch things using node-pre-gyp - so change this later.
            - make test

  - name: "Linux amd64: Build, test, lint"
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-2
      prologue:
        commands:
          - npm install # this will actually not build anything if we have a release, but rather, fetch things using node-pre-gyp - so change this later.
      jobs:
        - name: "Test"
          commands:
            - make test
        - name: "ESLint"
          commands:
            - npx eslint lib/kafkajs

  - name: "Linux amd64: Release"
    dependencies: [ ]
    run:
      when: "tag =~ '^v[0-9]\\.'"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-2
      env_vars:
        - name: ARCHITECTURE
          value: "x64"
        - name: PLATFORM
          value: "linux"
        - name: LIBC
          value: "glibc"
      jobs:
        - name: "Release: LTS:18"
          commands:
            - sem-version node 18.19.0
            - export NODE_ABI=108
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-${PLATFORM}-${LIBC}-${ARCHITECTURE}.tar.gz"
            - npm install # node-pre-gyp will fallback to build here, because new tag implies no release yet.
            - npx node-pre-gyp package
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
        - name: "Release: LTS:20"
          commands:
            - sem-version node 20.10.0
            - export NODE_ABI=115
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-${PLATFORM}-${LIBC}-${ARCHITECTURE}.tar.gz"
            - npm install # node-pre-gyp will fallback to build here, because new tag implies no release yet.
            - npx node-pre-gyp package
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
        - name: "Release: latest: 21"
          commands:
            - sem-version node 21.4.0
            - export NODE_ABI=120
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-${PLATFORM}-${LIBC}-${ARCHITECTURE}.tar.gz"
            - npm install # node-pre-gyp will fallback to build here, because new tag implies no release yet.
            - npx node-pre-gyp package
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"

  - name: "Linux arm64: Release"
    dependencies: [ ]
    run:
      when: "tag =~ '^v[0-9]\\.'"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-arm64-1
      env_vars:
        - name: ARCHITECTURE
          value: "arm64"
        - name: PLATFORM
          value: "linux"
        - name: LIBC
          value: "glibc"
      jobs:
        - name: "Release: LTS:18"
          commands:
            - sem-version node 18.19.0
            - export NODE_ABI=108
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-${PLATFORM}-${LIBC}-${ARCHITECTURE}.tar.gz"
            - npm install # node-pre-gyp will fallback to build here, because new tag implies no release yet.
            - npx node-pre-gyp package
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
        - name: "Release: LTS:20"
          commands:
            - sem-version node 20.10.0
            - export NODE_ABI=115
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-${PLATFORM}-${LIBC}-${ARCHITECTURE}.tar.gz"
            - npm install # node-pre-gyp will fallback to build here, because new tag implies no release yet.
            - npx node-pre-gyp package
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
        - name: "Release: latest: 21"
          commands:
            - sem-version node 21.4.0
            - export NODE_ABI=120
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-${PLATFORM}-${LIBC}-${ARCHITECTURE}.tar.gz"
            - npm install # node-pre-gyp will fallback to build here, because new tag implies no release yet.
            - npx node-pre-gyp package
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"

  - name: "Linux amd64 musl: Release"
    dependencies: [ ]
    run:
      when: "tag =~ '^v[0-9]\\.'"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-1
      env_vars:
        - name: ARCHITECTURE
          value: "x64"
        - name: PLATFORM
          value: "linux"
        - name: LIBC
          value: "musl"
      jobs:
        - name: "Release: LTS:18"
          commands:
            - export NODE_ABI=108
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-linux-${LIBC}-${ARCHITECTURE}.tar.gz"
            - docker run -v "$(pwd):/v" node:18-alpine /v/.semaphore/build-docker.sh
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
        - name: "Release: LTS:20"
          commands:
            - export NODE_ABI=115
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-linux-${LIBC}-${ARCHITECTURE}.tar.gz"
            - docker run -v "$(pwd):/v" node:20-alpine /v/.semaphore/build-docker.sh
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
        - name: "Release: latest: 21"
          commands:
            - export NODE_ABI=120
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-linux-${LIBC}-${ARCHITECTURE}.tar.gz"
            - docker run -v "$(pwd):/v" node:21-alpine /v/.semaphore/build-docker.sh
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"

  - name: "Linux arm64 musl: Release"
    dependencies: [ ]
    run:
      when: "tag =~ '^v[0-9]\\.'"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-arm64-1
      env_vars:
        - name: ARCHITECTURE
          value: "arm64"
        - name: PLATFORM
          value: "linux"
        - name: LIBC
          value: "musl"
      jobs:
        - name: "Release: LTS:18"
          commands:
            - export NODE_ABI=108
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-linux-${LIBC}-${ARCHITECTURE}.tar.gz"
            - docker run -v "$(pwd):/v" node:18-alpine /v/.semaphore/build-docker.sh
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
        - name: "Release: LTS:20"
          commands:
            - export NODE_ABI=115
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-linux-${LIBC}-${ARCHITECTURE}.tar.gz"
            - docker run -v "$(pwd):/v" node:20-alpine /v/.semaphore/build-docker.sh
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
        - name: "Release: latest: 21"
          commands:
            - export NODE_ABI=120
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-linux-${LIBC}-${ARCHITECTURE}.tar.gz"
            - docker run -v "$(pwd):/v" node:21-alpine /v/.semaphore/build-docker.sh
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"

  - name: "macOS arm64/m1: Release"
    dependencies: [ ]
    run:
      when: "tag =~ '^v[0-9]\\.'"
    task:
      agent:
        machine:
          type: s1-prod-macos-13-5-arm64
      env_vars:
        - name: ARCHITECTURE
          value: "arm64"
        - name: PLATFORM
          value: "darwin"
        - name: LIBC
          value: "unknown"
      jobs:
        - name: "Release: LTS:18"
          commands:
            - sem-version node 18.19.0
            - export NODE_ABI=108
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-${PLATFORM}-${LIBC}-${ARCHITECTURE}.tar.gz"
            - npm install # node-pre-gyp will fallback to build here, because new tag implies no release yet.
            - npx node-pre-gyp package
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
        - name: "Release: LTS:20"
          commands:
            - sem-version node 20.10.0
            - export NODE_ABI=115
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-${PLATFORM}-${LIBC}-${ARCHITECTURE}.tar.gz"
            - npm install # node-pre-gyp will fallback to build here, because new tag implies no release yet.
            - npx node-pre-gyp package
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
        - name: "Release: latest: 21"
          commands:
            - sem-version node 21.4.0
            - export NODE_ABI=120
            - export ARTIFACT_KEY="confluent-kafka-js-${SEMAPHORE_GIT_TAG_NAME}-node-v${NODE_ABI}-${PLATFORM}-${LIBC}-${ARCHITECTURE}.tar.gz"
            - npm install # node-pre-gyp will fallback to build here, because new tag implies no release yet.
            - npx node-pre-gyp package
            - ls build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}
            - artifact push project "build/stage/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}" --destination "releases/${SEMAPHORE_GIT_TAG_NAME}/${ARTIFACT_KEY}"
