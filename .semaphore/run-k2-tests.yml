version: v1.0
name: run-k2-tests
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-3

execution_time_limit:
  hours: 3

global_job_config:
  prologue:
    commands:
      - export SEMAPHORE_GIT_DIR=/home/semaphore/${SEMAPHORE_PROJECT_NAME}
      - mkdir -vp "${SEMAPHORE_GIT_DIR}"
      - checkout

blocks:
  - name: "K2 Testing Setup"
    task:
      jobs:
        - name: "Get kubectl access"
          commands:
            # Setup Vault
            - . vault-setup
            - . vault-sem-get-secret cc-system-tests
            - . vault-sem-get-secret GCP_CONNECT_CREDENTIALS_DEVEL
            # Install oidc-kubelogin
            - curl -sL https://github.com/int128/kubelogin/releases/download/v1.28.0/kubelogin_linux_amd64.zip -o /tmp/kubelogin.zip && unzip -o /tmp/kubelogin.zip -d /tmp && sudo mv /tmp/kubelogin /usr/local/bin/oidc-kubelogin && chmod +x /usr/local/bin/oidc-kubelogin
            # Clone helper repos and use their setup scripts
            - git clone --depth 1 git@github.com:confluentinc/cc-dotfiles.git ${SEMAPHORE_GIT_DIR}/cc-dotfiles
            - git clone --depth 1 git@github.com:confluentinc/cc-mk-include.git ${SEMAPHORE_GIT_DIR}/mk-include
            - export "PATH=${SEMAPHORE_GIT_DIR}/cc-dotfiles/bin/k8saas-ga:${PATH}"
            - |
              cd ${SEMAPHORE_GIT_DIR}
              . mk-include/bin/cc-system-tests/setup_kubeconfig.sh devel
            - export KUBECONFIG=$HOME/.kube/ccloud-config/devel/kubeconfig
            # Clone cc-dotfiles for kubectl helpers
            - git clone --depth 1 git@github.com:confluentinc/cc-dotfiles.git ~/cc-dotfiles
            - export PATH=~/cc-dotfiles/bin/k8saas-ga:$PATH
            # Test kubectl
            - kubectl config get-contexts
            - kubectl --context ${K8S_CONTEXT:-k8s-devcnn3k3} get namespaces
            # Sleep for debugging
            - |
              echo "=============================================="
              echo "kubectl access is working!"
              echo "Sleeping for 2 hours for manual debugging"
              echo "=============================================="
              sleep 7200
