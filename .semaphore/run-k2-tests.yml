version: v1.0
name: run-k2-tests
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-3

execution_time_limit:
  hours: 3

global_job_config:
  prologue:
    commands:
      - sem-version go 1.23.6
      - sem-version python 3.9
      - sem-version kubectl 1.22.6
      - export "GOPATH=$(go env GOPATH)"
      - export "SEMAPHORE_GIT_DIR=${GOPATH}/src/github.com/confluentinc/${SEMAPHORE_PROJECT_NAME}"
      - export "PATH=${GOPATH}/bin:${PATH}"
      - export "PATH=${SEMAPHORE_GIT_DIR}/cc-dotfiles/bin/k8saas-ga:${PATH}"
      - mkdir -vp "${SEMAPHORE_GIT_DIR}" "${GOPATH}/bin"
      - checkout
      - . vault-setup
      - . vault-sem-get-secret cc-system-tests
      - . vault-sem-get-secret GCP_CONNECT_CREDENTIALS_DEVEL
      - . vault-sem-get-secret data-dog-creds
      - . vault-sem-get-secret azure_credentials
      - . vault-sem-get-secret azure_byok_client_credentials
      - . vault-sem-get-secret azure-traffic-pl-vm-credentials
      - . vault-sem-get-secret connect_jdbc_credentials
      - . vault-sem-get-secret CONNECT_MONGODB_ATLAS_PASSWORD
      - . vault-sem-get-secret CONNECT_SNOWFLAKE_PRIVATE_KEY
      - . vault-sem-get-secret connect_redshift_credentials
      - . vault-sem-get-secret byok_aws_credentials
      - . vault-sem-get-secret byok_gcp_credentials
      - export AWS_AUTH_METHOD=aws-creds

blocks:
  - name: "K2 Testing Setup"
    task:
      jobs:
        - name: "Get kubectl access"
          commands:
            # Install oidc-kubelogin
            - curl -sL https://github.com/int128/kubelogin/releases/download/v1.28.0/kubelogin_linux_amd64.zip -o /tmp/kubelogin.zip && unzip -o /tmp/kubelogin.zip -d /tmp && sudo mv /tmp/kubelogin /usr/local/bin/oidc-kubelogin && chmod +x /usr/local/bin/oidc-kubelogin
            # Clone helper repos
            - git clone --depth 1 git@github.com:confluentinc/cc-dotfiles.git ${SEMAPHORE_GIT_DIR}/cc-dotfiles
            - git clone --depth 1 git@github.com:confluentinc/cc-mk-include.git ${SEMAPHORE_GIT_DIR}/mk-include
            # Set up AWS OIDC token for direct AWS auth
            - echo "$SEMAPHORE_OIDC_TOKEN" > /home/semaphore/.aws/semaphore_oidc_token
            - export AWS_WEB_IDENTITY_TOKEN_FILE=/home/semaphore/.aws/semaphore_oidc_token
            - export DISABLE_AWS_LOAD_CREDS=1
            # Create AWS profile for account 581884925347 (where k8s-devcnn3k3 cluster is)
            - |
              cat >> ~/.aws/config << EOF
              [profile 581884925347]
              role_arn = arn:aws:iam::581884925347:role/semaphore-access
              web_identity_token_file = /home/semaphore/.aws/semaphore_oidc_token
              EOF
            # Test AWS auth to account 581884925347
            - echo "Testing AWS auth to account 581884925347..."
            - aws --profile 581884925347 sts get-caller-identity
            # Set up kubeconfig for the cluster using AWS EKS
            - aws --profile 581884925347 eks update-kubeconfig --region us-west-2 --name k8saas-k8s-devcnn3k3 --alias k8s-devcnn3k3
            # Test kubectl
            - echo "Testing kubectl access..."
            - kubectl --context k8s-devcnn3k3 get namespaces
            - kubectl --context k8s-devcnn3k3 get pod anl-le-new
            - echo "SUCCESS! kubectl access is working!"
            # Sleep for SSH debugging
            - echo "Sleeping for 2 hours for SSH debugging..."
            - sleep 7200
