version: v1.0
name: run-all-tests

agent:
  machine:
    type: s1-prod-ubuntu24-04-arm64-1

execution_time_limit:
  hours: 3

global_job_config:
  env_vars:
    - name: TEST_COVERAGE
      value: "True"
  prologue:
    commands:
      - checkout
      - '[[ -z "$GIT_REF" ]] || git checkout $GIT_REF'
      - sudo apt update
      - sudo apt remove -y needrestart
      - sudo apt install -y gcovr libcurl4-openssl-dev
      - sem-version java 17

blocks:
  - name: "Run all tests (x86_64)"
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-ubuntu24-04-amd64-2
      prologue:
        commands:
          - if [[ "$TEST_ARCHES" != *"x86_64"* ]]; then
              return 130;
            fi
      jobs:
        - name: "PLAINTEXT cluster (x86_64)"
          env_vars:
            - name: TEST_SSL
              value: "False"
          commands:
            - if [[ "$TEST_TYPE" != *"plaintext"* ]]; then
                return 130;
              fi
            - ./tests/run-all-tests.sh x86_64_plaintext
        - name: "SSL cluster (x86_64)"
          env_vars:
            - name: TEST_SSL
              value: "True"
          commands:
            - if [[ "$TEST_TYPE" != *"ssl"* ]]; then
                return 130;
              fi
            - ./tests/run-all-tests.sh x86_64_ssl
  - name: "Run all tests (aarch64)"
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-ubuntu24-04-arm64-2
      prologue:
        commands:
          - if [[ "$TEST_ARCHES" != *"aarch64"* ]]; then
              return 130;
            fi
      jobs:
        - name: "PLAINTEXT cluster (aarch64)"
          env_vars:
            - name: TEST_SSL
              value: "False"
          commands:
            - if [[ "$TEST_TYPE" != *"plaintext"* ]]; then
                return 130;
              fi
            - ./tests/run-all-tests.sh aarch64_plaintext
        - name: "SSL cluster (aarch64)"
          env_vars:
            - name: TEST_SSL
              value: "True"
          commands:
            - if [[ "$TEST_TYPE" != *"ssl"* ]]; then
                return 130;
              fi
            - ./tests/run-all-tests.sh aarch64_ssl

after_pipeline:
  task:
    env_vars:
      - name: TEST_COVERAGE
        value: "True"
    jobs:
      - name: Coverage report
        commands:
          - if [[ "$TEST_COVERAGE" != "True" ]]; then
              return 130;
            fi
          - checkout
          - '[[ -z "$GIT_REF" ]] || git checkout $GIT_REF'
          - sudo apt update
          - sudo apt remove -y needrestart
          - sudo apt install -y gcovr
          - sem-version java 17
          - ./tests/run-all-tests.sh coverage_report
