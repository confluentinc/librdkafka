version: v1.0
name: run-k2-tests
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-3

execution_time_limit:
  hours: 3

blocks:
  - name: "K2 Testing Setup"
    task:
      jobs:
        - name: "Get kubectl access"
          commands:
            # Setup Vault
            - . vault-setup
            - . vault-sem-get-secret cc-system-tests
            - . vault-sem-get-secret GCP_CONNECT_CREDENTIALS_DEVEL
            # Install oidc-kubelogin
            - curl -sL https://github.com/int128/kubelogin/releases/download/v1.28.0/kubelogin_linux_amd64.zip -o /tmp/kubelogin.zip && unzip -o /tmp/kubelogin.zip -d /tmp && sudo mv /tmp/kubelogin /usr/local/bin/oidc-kubelogin && chmod +x /usr/local/bin/oidc-kubelogin
            # Assume AWS role
            - . assume-iam-role arn:aws:iam::037803949979:role/semaphore-access
            - aws sts get-caller-identity
            # Download kubeconfig from GCS (write creds to file first)
            - echo "$GCP_CONNECT_CREDENTIALS_DEVEL_JSON" > /tmp/devel.json
            - gcloud auth activate-service-account --key-file=/tmp/devel.json
            - mkdir -p ~/.kube/ccloud-config/devel
            - gsutil cp gs://k8saas-prod-user-kubeconfigs/k8saas-generated/devel/kubeconfig ~/.kube/ccloud-config/devel/kubeconfig
            - export KUBECONFIG=~/.kube/ccloud-config/devel/kubeconfig
            # Clone cc-dotfiles for kubectl helpers
            - git clone --depth 1 git@github.com:confluentinc/cc-dotfiles.git ~/cc-dotfiles
            - export PATH=~/cc-dotfiles/bin/k8saas-ga:$PATH
            # Test kubectl
            - kubectl config get-contexts
            - kubectl --context ${K8S_CONTEXT:-k8s-devcnn3k3} get namespaces
            # Sleep for debugging
            - |
              echo "=============================================="
              echo "kubectl access is working!"
              echo "Sleeping for 2 hours for manual debugging"
              echo "=============================================="
              sleep 7200
